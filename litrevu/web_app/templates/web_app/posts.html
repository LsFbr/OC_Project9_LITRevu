{% extends 'web_app/base.html' %}
{% block title %}Vos posts - LITRevu{% endblock %}
{% block content %}
<div class="container text-center mx-auto px-4">
    <h1 class="text-2xl font-bold text-gray-800">Vos posts</h1>
</div>
{% for item in content %}
    <div class="max-w-2xl mx-auto bg-white rounded shadow p-4 mt-6">
        {% if item.content_type == "ticket" %}
            <div class="flex justify-between items-center">
                <p class="text-gray-600 text-sm mb-2">
                    Vous avez demandé une critique
                </p>
                <p class="text-gray-600 text-sm mb-2">
                    {{ item.time_created|date:"H:i d M Y" }}
                </p>
            </div>
            <h2 class="text-lg font-semibold text-gray-800 mb-2">{{ item.title }}</h2>
            <p class="text-gray-700 mb-4">{{ item.description }}</p>
            {% if item.image %}
                <img src="{{ item.image.url }}" alt="Image illustrant le ticket : {{ item.title }}" class="w-auto max-h-64 object-cover rounded mb-4">
            {% endif %}
            <div class="flex justify-end gap-4">
                <a href="{% url 'edit_ticket' item.id %}" class="border border-gray-800 text-gray-800 font-medium py-2 px-6 rounded hover:bg-gray-100"
                aria-label="Modifier le ticket {{ item.title }}">
                    Modifier
                </a>
                <button
                    onclick='openDeleteModal("ticket", {{ item.id }}, "{{ item.title|escapejs }}")'
                    class="border border-gray-800 text-gray-800 font-medium py-2 px-6 rounded hover:bg-gray-100"
                    aria-label="Supprimer le ticket {{ item.title }}">
                    Supprimer
                </button>
            </div>
        {% else %} {# review #}
            <div class="flex justify-between items-center">
                <p class="text-gray-600 text-sm mb-2">
                    Vous avez publié une critique
                </p>
                <p class="text-gray-600 text-sm">{{ item.time_created|date:"H:i, d M Y" }}</p>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-1">
                {{ item.headline }} - 
                <span class="text-amber-800 ml-2" aria-label="Note : {{ item.rating }} sur 5 étoiles">
                    {% for i in "12345" %}
                        {% if forloop.counter <= item.rating %}
                            <span aria-hidden="true">★</span>
                        {% else %}
                            <span aria-hidden="true">☆</span>
                        {% endif %}
                    {% endfor %}
                </span>
            </h3>
            <p class="text-gray-700 mb-4 whitespace-pre-line">{{ item.body }}</p>

            <div class="bg-gray-50 rounded p-3">
                <p class="text-sm text-gray-600 mb-2">Ticket - {% if item.ticket.user == user %}Vous{% else %}{{ item.ticket.user.username }}{% endif %}</p>
                <h4 class="font-medium text-gray-800">{{ item.ticket.title }}</h4>
                <p class="text-gray-700 mb-2">{{ item.ticket.description }}</p>
                {% if item.ticket.image %}
                <img src="{{ item.ticket.image.url }}" alt="Image illustrant le ticket : {{ item.ticket.title }}" class="w-auto max-h-48 object-cover rounded">
                {% endif %}
            </div>
            <div class="flex justify-end gap-4 mt-4">
                <a href="{% url 'edit_review' item.id %}" class="border border-gray-800 text-gray-800 font-medium py-2 px-6 rounded hover:bg-gray-100"
                aria-label="Modifier la critique de {{ item.ticket.title }}">
                    Modifier
                </a>
                <button
                    onclick='openDeleteModal("review", {{ item.id }}, "{{ item.ticket.title|escapejs }}")'
                    class="border border-gray-800 text-gray-800 font-medium py-2 px-6 rounded hover:bg-gray-100"
                    aria-label="Supprimer la critique de {{ item.ticket.title }}">
                    Supprimer
                </button>
            </div>
        {% endif %}
    </div>
{% empty %}
    <p class="text-center text-gray-600 mt-8">Vous n'avez rien posté pour le moment.</p>
{% endfor %}
<div id="deleteModal" 
     class="flex fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" 
     role="dialog" 
     aria-modal="true" 
     aria-labelledby="deleteModalTitle" 
     aria-describedby="deleteModalMessage">
    <div class="bg-white rounded-lg p-6 max-w-md w-full text-center">
        <h2 class="text-lg font-bold text-gray-800 mb-4" id="deleteModalTitle"></h2>
        <p class="text-gray-700 mb-4" id="deleteModalMessage"></p>
        <form id="deleteForm" method="post">
            {% csrf_token %}
            <div class="flex justify-center gap-4 mt-6">
                <button type="button" onclick="closeDeleteModal()" class="text-gray-600 hover:text-gray-800">Annuler</button>
                <button type="submit" class="bg-red-800 text-white font-medium py-2 px-6 rounded hover:bg-red-800">
                    Supprimer
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    function openDeleteModal(type, item_Id, ticketTitle) {
        const modal = document.getElementById("deleteModal");
        const title = document.getElementById("deleteModalTitle");
        const message = document.getElementById("deleteModalMessage");
        const form = document.getElementById("deleteForm");
        
        if (type === "ticket") {
            title.textContent = "Supprimer ce ticket ?";
            message.textContent = `Êtes-vous sûr de vouloir supprimer votre ticket "${ticketTitle}" ?`;
            form.action = `/ticket/delete/${item_Id}/`;
        } else if (type === "review") {
            title.textContent = "Supprimer cette critique ?";
            message.textContent = `Êtes-vous sûr de vouloir supprimer votre critique de "${ticketTitle}" ?`;
            form.action = `/review/delete/${item_Id}/`;
        }
    
        modal.classList.remove("hidden");
    }
    
    function closeDeleteModal() {
        const modal = document.getElementById("deleteModal");
        modal.classList.add("hidden");
    }
    
    // Fermeture avec Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById("deleteModal");
            if (!modal.classList.contains("hidden")) {
                closeDeleteModal();
            }
        }
    });
</script>
{% endblock %}